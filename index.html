<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Private Chat</title>

  <!-- Supabase library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{
      margin:0;
      font-family:sans-serif;
      height:100vh;
      display:flex;
      flex-direction:column;
      background:#111;
      background-size:cover;
      background-position:center;
    }

    #chat{
      flex:1;
      overflow:auto;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .msg{
      max-width:70%;
      padding:8px 12px;
      border-radius:12px;
      color:white;
      word-wrap:break-word;
    }

    .me{
      align-self:flex-end;
      background:#00c853;
    }

    .other{
      align-self:flex-start;
      background:#2962ff;
    }

    img{
      max-width:160px;
      border-radius:8px;
      margin-top:4px;
    }

    #bar{
      display:flex;
      gap:6px;
      padding:6px;
      background:#00000090;
    }

    input[type="text"]{
      flex:1;
      padding:6px;
    }
  </style>
</head>

<body>

<!-- Background picker -->
<input type="file" id="bgPicker">

<div id="chat"></div>

<div id="bar">
  <input id="text" type="text" placeholder="Type message...">
  <input type="file" id="img">
  <button onclick="send()">Send</button>
</div>


<script>
/* ðŸ”¥ SUPABASE CONNECTED */
const supabase = window.supabase.createClient(
  "https://hfzqtavmibzfivcsppxw.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhmenF0YXZtaWJ6Zml2Y3NwcHh3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MjMyNDksImV4cCI6MjA4NjE5OTI0OX0.VNiwt6SSHjHUln6fJJ3ypjYvNG_u61krVK49lH89eLc"
);


/* username */
const username = prompt("Enter your name");

const chat = document.getElementById("chat");


/* background change */
bgPicker.onchange = e=>{
  const r=new FileReader();
  r.onload=()=>document.body.style.backgroundImage=`url(${r.result})`;
  r.readAsDataURL(e.target.files[0]);
};


/* send message */
async function send(){

  const text=document.getElementById("text").value;
  const file=document.getElementById("img").files[0];

  let image=null;

  if(file){
    const r=new FileReader();
    r.onload=async ()=>{
      image=r.result;

      await supabase.from("messages").insert({
        text:text,
        user:username,
        image:image
      });
    };
    r.readAsDataURL(file);
  }
  else{
    await supabase.from("messages").insert({
      text:text,
      user:username
    });
  }

  document.getElementById("text").value="";
}


/* load old messages */
async function load(){
  const {data}=await supabase
    .from("messages")
    .select("*")
    .order("id");

  data.forEach(addMsg);
}


/* realtime listener */
supabase.channel("chat")
.on(
  "postgres_changes",
  {event:"INSERT",schema:"public",table:"messages"},
  payload=>addMsg(payload.new)
)
.subscribe();


function addMsg(m){
  const div=document.createElement("div");
  div.className="msg "+(m.user===username?"me":"other");

  div.innerHTML=`<b>${m.user}</b><br>${m.text||""}`;

  if(m.image){
    div.innerHTML+=`<br><img src="${m.image}">`;
  }

  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
}


load();

</script>

</body>
</html>
